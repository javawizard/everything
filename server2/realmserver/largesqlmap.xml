<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap>
    <!-- !ADDTOSQL -->

    <update id="updateStoredMessageInfo" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        update $$prefix$$storedmessages set sender = #sender#,
        recipient=#recipient#,fromcomputer=#fromcomputer#,
        tocomputer=#tocomputer#,maxchunks=#maxchunks#,
        maxchunksize=#maxchunksize#,lifecycle=#lifecycle#,
        lifecycleprogress=#lifecycleprogress#,needslifecycleupdate
        =#needslifecycleupdate#,finalized=#finalized#,
        approved=#approved#
        where id = #id#
    </update>

    <select id="getStoredMessageDataSize" 
         parameterClass="java.lang.String" 
         resultClass="java.lang.Integer" >
        select sum(length(contents)) from storedmessagedata
        where id = #value#
    </select>

    <select id="getStoredMessageChunkCount" 
         parameterClass="java.lang.String" 
         resultClass="java.lang.Integer" >
        select count(*) from $$prefix$$storedmessagedata
        where id = #value#
    </select>

    <select id="getStoredMessageTotalSize" 
         parameterClass="java.lang.String" 
         resultClass="java.lang.Long" >
        select (select sum(length(contents)) from 
        $$prefix$$storedmessagedata where id in (select id from
        $$prefix$$storedmessages where (sender = #value# and
        approved = false) or (recipient = #value# and approved
        = true) + (select sum(length(metadata)+10) from
        $$prefix$$storedmessages where (sender = #value# and
        approved = false) or (recipient = #value# and approved
        = true))
    </select>

    <select id="getStoredMessageInfo" 
         parameterClass="java.lang.String" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        select id,sender,recipient,fromcomputer,tocomputer,
        maxchunks,maxchunksize,lifecycle,lifecycleprogress,
        lifecycletotal,needslifecycleupdate,finalized,approved
        from $$prefix$$storedmessages
        where id = #value#
    </select>

    <select id="listOutboundMessageInfo" 
         parameterClass="java.lang.String" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        select id,sender,recipient,fromcomputer,
        tocomputer,maxchunks,maxchunksize,lifecycle,lifecycleprogress
        ,lifecycletotal,needslifecycleupdate,finalized,approved
        from $$prefix$$storedmessages where approved=false
        and sender=#value#
    </select>

    <select id="listUnapprovedMessageInfo" 
         parameterClass="java.lang.String" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        select id,sender,recipient,fromcomputer,
        tocomputer,maxchunks,maxchunksize,lifecycle,lifecycleprogress
        ,lifecycletotal,needslifecycleupdate,finalized,approved
        from $$prefix$$storedmessages where finalized=true
        and approved=false and recipient=#value#
    </select>

    <select id="listApprovedMessageInfo" 
         parameterClass="java.lang.String" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        select id,sender,recipient,fromcomputer,
        tocomputer,maxchunks,maxchunksize,lifecycle,lifecycleprogress
        ,lifecycletotal,needslifecycleupdate,finalized,approved
        from $$prefix$$storedmessages where approved
        = true and recipient = #value#
    </select>

    <select id="getMessageMetadata" 
         parameterClass="java.lang.String" 
         resultClass="java.lang.String" >
        select metadata from $$prefix$$storedmessages where id
        = #value#
    </select>

    <select id="listSoftDeletes" 
         parameterClass="java.lang.String" 
         resultClass="net.sf.opengroove.realmserver.data.model.SoftDelete" >
        select * from $$prefix$$softdeletes where id = #value#
    </select>

    <delete id="deleteSoftDeletesForMessage" 
         parameterClass="java.lang.String" >
        delete from $$prefix$$softdeletes where id = #value#
    </delete>

    <delete id="deleteSoftDelete" 
         parameterClass="net.sf.opengroove.realmserver.data.model.SoftDelete" >
        delete from $$prefix$$softdeletes where id = #id# and computer
        = #computer#
    </delete>

    <insert id="insertSoftDelete" 
         parameterClass="net.sf.opengroove.realmserver.data.model.SoftDelete" >
        insert into $$prefix$$softdeletes values (#id#,#computer#)
    </insert>

    <select id="listStoredMessageDataForMessage" 
         parameterClass="java.lang.String" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" >
        select id,block,read from $$prefix$$storedmessagedata where
        id = #value#
    </select>

    <select id="getStoredMessageData" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" >
        select * from $$prefix$$storedmessagedata where id = #id#
        and block=#block#
    </select>

    <select id="getStoredMessageDataInfo" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" 
         resultClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" >
        select id,block,read from $$prefix$$storedmessagedata where
        id = #id# and block=#block#
    </select>

    <update id="updateStoredMessageData" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" >
        update $$prefix$$storedmessagedata set contents = #contents#
        where id = #id# and block = #block#
    </update>

    <update id="updateStoredMessageDataInfo" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" >
        update $$prefix$$storedmessagedata set read = #read# where
        id = #id# and block = #block#
    </update>

    <insert id="insertStoredMessageData" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessageData" >
        insert into $$prefix$$storedmessagedata values (#id#,
        #block#,#read#,#contents#)
    </insert>

    <delete id="deleteStoredMessage" 
         parameterClass="java.lang.String" >
        delete from $$prefix$$storedmessages where id = #value#
    </delete>

    <update id="updateStoredMessage" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        update $$prefix$$storedmessages set sender = #sender#,
        recipient=#recipient#,fromcomputer=#fromcomputer#,
        tocomputer=#tocomputer#,maxchunks=#maxchunks#,
        maxchunksize=#maxchunksize#,lifecycle=#lifecycle#,
        lifecycleprogress=#lifecycleprogress#,needslifecycleupdate
        =#needslifecycleupdate#,finalized=#finalized#,
        approved=#approved#,metadata=#metadata#
        where id = #id#
    </update>

    <insert id="insertStoredMessage" 
         parameterClass="net.sf.opengroove.realmserver.data.model.StoredMessage" >
        insert into $$prefix$$storedmessages values (
        #id#,#sender#,#recipient#,#fromcomputer#,
        #tocomputer#,#maxchunks#,#maxchunksize#,
        #lifecycle#,#lifecycleprogress#,#lifecycletotal#,
        #needslifecycleupdate#,#finalized#,#approved#,
        #metadata#
        )
    </insert>
</sqlMap>